# Vue Pure Admin API调用流程图

本文档提供了Vue Pure Admin项目中API调用的详细流程图，帮助开发者理解项目的数据流转和请求处理机制。

## API调用系统整体架构

```
+---------------------------------------------------------------+
|                        业务组件/页面                            |
+---------------------------------------------------------------+
                |                  ^
                | 调用API          | 返回数据/错误
                v                  |
+---------------------------------------------------------------+
|                      API模块 (src/api/*.ts)                    |
|                                                               |
|   +---------------------+   +-----------------------------+   |
|   | 用户API (user.ts)    |   | 路由API (routes.ts)         |   |
|   +---------------------+   +-----------------------------+   |
|   | 系统API (system.ts)  |   | 业务模块API (module/*.ts)   |   |
|   +---------------------+   +-----------------------------+   |
+---------------------------------------------------------------+
                |                  ^
                | 封装请求         | 处理响应
                v                  |
+---------------------------------------------------------------+
|                   HTTP工具模块 (utils/http)                    |
|                                                               |
|   +---------------------+   +-----------------------------+   |
|   | 请求拦截器           |   | 响应拦截器                  |   |
|   | - 添加Token         |   | - 统一错误处理               |   |
|   | - 处理请求格式       |   | - Token刷新                 |   |
|   +---------------------+   +-----------------------------+   |
|                                                               |
|   +---------------------+   +-----------------------------+   |
|   | 请求重试机制         |   | 响应数据转换                |   |
|   +---------------------+   +-----------------------------+   |
+---------------------------------------------------------------+
                |                  ^
                | HTTP请求         | HTTP响应
                v                  |
+---------------------------------------------------------------+
|                       后端API / Mock数据                       |
+---------------------------------------------------------------+
```

## 基本API调用流程

```mermaid
graph TD
    A[组件/页面] --> B[调用API模块方法]
    B --> C[API模块封装请求参数]
    C --> D[调用utils/http模块]
    D --> E[请求拦截器]
    E --> F[添加Token等认证信息]
    F --> G[发送HTTP请求]
    G --> H[响应拦截器]
    H --> I{响应状态判断}
    I -->|成功| J[格式化响应数据]
    I -->|失败| K[错误处理]
    J --> L[返回数据到调用方]
    K --> M[全局错误处理]
    M -->|Token过期| N[刷新Token]
    N -->|成功| O[重试原请求]
    N -->|失败| P[跳转到登录页]
    M -->|其他错误| Q[展示错误提示]
```

## Token刷新流程

```mermaid
graph TD
    A[响应拦截器检测到Token过期] --> B{是否正在刷新Token?}
    B -->|是| C[将请求加入等待队列]
    B -->|否| D[设置刷新Token标志]
    D --> E[调用刷新Token API]
    E --> F{刷新是否成功?}
    F -->|成功| G[更新Token存储]
    G --> H[重试所有等待队列中的请求]
    F -->|失败| I[清除登录状态]
    I --> J[跳转到登录页]
```

## 路由加载与API调用关系

```mermaid
graph TD
    A[应用启动] --> B[初始化Vue Router]
    B --> C[调用initRouter函数]
    C --> D[调用getAsyncRoutes API]
    D --> E{API调用是否成功?}
    E -->|成功| F[处理返回的路由数据]
    F --> G[添加路由到Vue Router]
    E -->|失败| H[使用本地路由数据]
    H --> G
    G --> I[完成路由初始化]
```

## 登录流程与API调用

```mermaid
graph TD
    A[用户输入账号密码] --> B[提交表单]
    B --> C[调用loginByUsername API]
    C --> D{登录是否成功?}
    D -->|成功| E[保存Token和用户信息]
    E --> F[加载用户权限]
    F --> G[初始化路由]
    G --> H[跳转到首页]
    D -->|失败| I[显示错误信息]
```

## 权限加载流程

```mermaid
graph TD
    A[登录成功后] --> B[获取用户基本信息]
    B --> C[获取用户角色列表]
    C --> D[调用getAsyncRoutes获取路由]
    D --> E[根据用户角色过滤路由]
    E --> F[生成有权限的菜单]
    F --> G[存储菜单到Pinia]
    G --> H[渲染侧边栏菜单]
```

## 请求错误处理流程

```mermaid
graph TD
    A[API请求发生错误] --> B{错误类型判断}
    B -->|网络错误| C[显示网络连接提示]
    B -->|401未授权| D{Token是否过期?}
    D -->|是| E[尝试刷新Token]
    E -->|成功| F[重试原请求]
    E -->|失败| G[跳转到登录页]
    D -->|否| H[显示权限不足提示]
    B -->|404| I[显示资源不存在提示]
    B -->|500| J[显示服务器错误提示]
    B -->|其他错误| K[显示通用错误提示]
```

## 组件与API的典型交互模式

### 列表页模式

```mermaid
graph TD
    A[列表页组件挂载] --> B[调用获取列表数据API]
    B --> C[展示loading状态]
    C --> D{API调用是否成功?}
    D -->|成功| E[更新列表数据]
    E --> F[更新分页信息]
    D -->|失败| G[显示错误提示]
    H[用户点击分页/筛选] --> I[重新调用获取列表API]
    I --> C
```

### 表单提交模式

```mermaid
graph TD
    A[用户填写表单] --> B[提交表单]
    B --> C[表单验证]
    C -->|验证失败| D[显示验证错误]
    C -->|验证通过| E[调用提交API]
    E --> F[显示提交中状态]
    F --> G{API调用是否成功?}
    G -->|成功| H[显示成功提示]
    H --> I[关闭表单/跳转页面]
    G -->|失败| J[显示错误提示]
    J --> K[恢复表单状态]
```

## API缓存策略

```mermaid
graph TD
    A[组件请求数据] --> B{数据是否已缓存?}
    B -->|是| C[使用缓存数据]
    B -->|否| D[发起API请求]
    D --> E{请求是否成功?}
    E -->|成功| F[缓存数据]
    F --> G[返回数据到组件]
    C --> G
    E -->|失败| H[返回错误到组件]
```

## API模块组织结构

```mermaid
graph LR
    A[src/api/index.ts] --> B[统一导出所有API]
    B --> C[用户相关API: user.ts]
    B --> D[路由相关API: routes.ts]
    B --> E[系统设置API: system.ts]
    B --> F[业务模块API: ...]
    G[utils/http/index.ts] --> H[请求封装]
    C & D & E & F --> G
```

此流程图文档旨在帮助开发者理解Vue Pure Admin项目中API调用的全流程，从组件发起请求到处理响应的完整路径，以及各种特殊情况下的处理逻辑。开发者可以参考这些流程图来理解系统的数据流，并在此基础上进行功能扩展或问题排查。 