# 菜单管理系统 - API文档

## 概述

菜单管理系统提供一组RESTful API，用于创建和管理菜单项，以及为用户分配菜单权限。所有API都使用JWT认证，并根据不同的操作设置相应的权限控制。

## 基础信息

- **基础URL**: `/api/v1/menus`
- **认证方式**: JWT Token Authentication
- **数据格式**: JSON
- **请求头要求**: `Authorization: Bearer {token}`

## API架构图

```
┌────────────────────────────────────────┐
│                                        │
│            菜单管理系统 API            │
│                                        │
└─┬──────────────────┬──────────────────┬┘
  │                  │                  │
  ▼                  ▼                  ▼
┌────────────┐  ┌────────────┐  ┌─────────────┐
│            │  │            │  │             │
│ 菜单管理   │  │管理员菜单  │  │ 用户菜单    │
│   API      │  │   API      │  │   API       │
│            │  │            │  │             │
└────────────┘  └────────────┘  └─────────────┘
```

## 统一响应格式

### 成功响应

```
┌─────────────────────────────────────────┐
│ HTTP 状态码: 2xx                        │
├─────────────────────────────────────────┤
│ {                                       │
│   "success": true,                      │
│   "code": 2000,                         │
│   "message": "操作成功",                │
│   "data": { ... }                       │
│ }                                       │
└─────────────────────────────────────────┘
```

### 错误响应

```
┌─────────────────────────────────────────┐
│ HTTP 状态码: 4xx/5xx                    │
├─────────────────────────────────────────┤
│ {                                       │
│   "success": false,                     │
│   "code": 4xxx,                         │
│   "message": "错误描述信息",            │
│   "data": null                          │
│ }                                       │
└─────────────────────────────────────────┘
```

## API端点详情

### 1. 菜单管理 API

#### 概览

```
┌────────────────────────────────────┐
│          菜单管理 API              │
└───┬────────────────────────────────┘
    │
    ├── GET    /api/v1/menus/           - 获取菜单列表
    │
    ├── GET    /api/v1/menus/tree/      - 获取菜单树形结构
    │
    ├── GET    /api/v1/menus/{id}/      - 获取单个菜单
    │
    ├── POST   /api/v1/menus/           - 创建菜单
    │
    ├── PUT    /api/v1/menus/{id}/      - 更新菜单
    │
    └── DELETE /api/v1/menus/{id}/      - 删除菜单
```

#### 1.1 获取菜单列表

- **请求方法**: `GET`
- **URL路径**: `/api/v1/menus/`
- **权限**: 超级管理员、管理员
- **描述**: 获取系统中的所有菜单项，超级管理员可获取所有菜单，管理员只能获取分配给自己的菜单
- **查询参数**:
  - `is_active`: 布尔值，筛选激活/未激活的菜单
  - `parent_id`: 整数，筛选特定父菜单的子菜单
  - `search`: 字符串，搜索菜单名称或标识符
  - `page`: 整数，分页页码
  - `page_size`: 整数，每页条数

**请求/响应流程图**:

```
┌─────────┐         ┌────────────┐          ┌────────────┐
│         │  请求   │            │  查询    │            │
│ 客户端  │────────►│ 视图控制器 │─────────►│  数据库    │
│         │         │            │          │            │
└─────────┘         └────────────┘          └────────────┘
    ▲                     │                       │
    │                     │                       │
    │                     │                       │
    │                     ▼                       │
    │              ┌────────────┐                 │
    │              │            │                 │
    │              │ 序列化数据 │◄────────────────┘
    │              │            │    返回数据
    │              └────────────┘
    │                     │
    │                     │
    └─────────────────────┘
          返回响应
```

**响应字段说明**:

```
┌─────────────────────────────┐
│ 菜单项数据结构              │
├─────────────────────────────┤
│ - id: 菜单唯一标识          │
│ - name: 菜单名称            │
│ - code: 菜单标识符          │
│ - icon: 菜单图标            │
│ - path: 前端路由路径        │
│ - component: 前端组件路径   │
│ - order: 排序序号           │
│ - parent_id: 父菜单ID       │
│ - is_active: 是否激活       │
│ - created_at: 创建时间      │
│ - updated_at: 更新时间      │
└─────────────────────────────┘
```

#### 1.2 获取菜单树形结构

- **请求方法**: `GET`
- **URL路径**: `/api/v1/menus/tree/`
- **权限**: 超级管理员、管理员
- **描述**: 获取菜单的树形结构，子菜单嵌套在父菜单内
- **查询参数**:
  - `is_active`: 布尔值，筛选激活/未激活的菜单

**树形结构示例图**:

```
┌─ 顶级菜单A
│  │
│  ├─ 子菜单A-1
│  │  │
│  │  └─ 子菜单A-1-1
│  │
│  └─ 子菜单A-2
│
└─ 顶级菜单B
   │
   ├─ 子菜单B-1
   │
   └─ 子菜单B-2
```

#### 1.3 获取单个菜单

- **请求方法**: `GET`
- **URL路径**: `/api/v1/menus/{id}/`
- **权限**: 超级管理员、管理员
- **描述**: 获取指定ID的菜单详情
- **路径参数**:
  - `id`: 菜单ID

**请求流程图**:

```
┌─────────┐      ┌────────────┐      ┌────────────┐
│         │ 请求 │            │ 查询 │            │
│ 客户端  │─────►│ 视图控制器 │─────►│  数据库    │
│         │      │            │      │            │
└─────────┘      └────────────┘      └────────────┘
    ▲                  │                   │
    │                  │                   │
    │                  ▼                   │
    │           ┌────────────┐             │
    │           │            │             │
    └───────────┤ 响应数据   │◄────────────┘
     返回响应   │            │  返回菜单或404
                └────────────┘
```

#### 1.4 创建菜单

- **请求方法**: `POST`
- **URL路径**: `/api/v1/menus/`
- **权限**: 仅限超级管理员
- **描述**: 创建新的菜单项

**请求字段说明**:

```
┌─────────────────────────────┐
│ 创建菜单请求数据            │
├─────────────────────────────┤
│ - name: 菜单名称 (必填)     │
│ - code: 菜单标识符 (必填)   │
│ - icon: 菜单图标            │
│ - path: 前端路由路径        │
│ - component: 前端组件路径   │
│ - order: 排序序号           │
│ - parent_id: 父菜单ID       │
│ - is_active: 是否激活       │
└─────────────────────────────┘
```

#### 1.5 更新菜单

- **请求方法**: `PUT`
- **URL路径**: `/api/v1/menus/{id}/`
- **权限**: 仅限超级管理员
- **描述**: 更新指定ID的菜单
- **路径参数**:
  - `id`: 菜单ID

**更新流程图**:

```
┌─────────┐      ┌────────────┐      ┌────────────┐
│         │ 请求 │            │ 验证 │            │
│ 客户端  │─────►│ 序列化器   │─────►│ 权限校验   │
│         │      │            │      │            │
└─────────┘      └────────────┘      └────────────┘
                                           │
                                           ▼
┌─────────┐      ┌────────────┐      ┌────────────┐
│         │ 响应 │            │ 保存 │            │
│ 客户端  │◄─────┤ 响应处理   │◄─────┤ 数据库操作 │
│         │      │            │      │            │
└─────────┘      └────────────┘      └────────────┘
```

#### 1.6 删除菜单

- **请求方法**: `DELETE`
- **URL路径**: `/api/v1/menus/{id}/`
- **权限**: 仅限超级管理员
- **描述**: 删除指定ID的菜单（同时会删除其所有子菜单）
- **路径参数**:
  - `id`: 菜单ID

**删除操作影响图**:

```
┌─ 菜单A (删除目标)
│  │
│  ├─ 子菜单A-1  ──┐
│  │               │
│  └─ 子菜单A-2  ──┼──► 级联删除
│     │            │
│     └─ 子菜单A-2-1 ┘
│
└─ 菜单B (不受影响)
```

### 2. 管理员菜单管理 API

#### 概览

```
┌─────────────────────────────────────────┐
│         管理员菜单管理 API               │
└────┬────────────────────────────────────┘
     │
     ├── GET    /api/v1/menus/admins/{user_id}/menus/      - 获取管理员菜单列表
     │
     ├── POST   /api/v1/menus/admins/{user_id}/menus/      - 分配菜单给管理员
     │
     ├── DELETE /api/v1/menus/admins/{user_id}/menus/{menu_id}/ - 移除管理员菜单
     │
     └── DELETE /api/v1/menus/admins/{user_id}/menus/batch/ - 批量移除管理员菜单
```

#### 2.1 获取管理员的菜单列表

- **请求方法**: `GET`
- **URL路径**: `/api/v1/menus/admins/{user_id}/menus/`
- **权限**: 超级管理员
- **描述**: 获取指定管理员的菜单列表
- **路径参数**:
  - `user_id`: 管理员用户ID

**响应数据结构**:

```
┌───────────────────────────────────────┐
│ 管理员菜单列表响应                    │
├───────────────────────────────────────┤
│ - user_id: 管理员ID                   │
│ - username: 管理员用户名              │
│ - menus: [                            │
│     {                                 │
│       - id: 菜单ID                    │
│       - name: 菜单名称                │
│       - code: 菜单标识符              │
│       - is_active: 是否激活           │
│     },                                │
│     ...                               │
│   ]                                   │
└───────────────────────────────────────┘
```

#### 2.2 分配菜单给管理员

- **请求方法**: `POST`
- **URL路径**: `/api/v1/menus/admins/{user_id}/menus/`
- **权限**: 仅限超级管理员
- **描述**: 为指定管理员分配菜单
- **路径参数**:
  - `user_id`: 管理员用户ID

**菜单分配流程图**:

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│             │ 请求  │             │ 验证  │             │
│ 超级管理员  │──────►│ API控制器   │──────►│ 权限校验    │
│             │       │             │       │             │
└─────────────┘       └─────────────┘       └─────────────┘
                                                  │
                                                  ▼
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│             │ 响应  │             │ 保存  │             │
│ 超级管理员  │◄──────┤ 响应生成    │◄──────┤ 关联记录    │
│             │       │             │       │             │
└─────────────┘       └─────────────┘       └─────────────┘
```

**请求数据格式**:

```
┌───────────────────────────┐
│ 菜单分配请求              │
├───────────────────────────┤
│ {                         │
│   "menu_ids": [1, 2, 3]   │
│ }                         │
└───────────────────────────┘
```

#### 2.3 移除管理员的菜单

- **请求方法**: `DELETE`
- **URL路径**: `/api/v1/menus/admins/{user_id}/menus/{menu_id}/`
- **权限**: 仅限超级管理员
- **描述**: 移除管理员的特定菜单
- **路径参数**:
  - `user_id`: 管理员用户ID
  - `menu_id`: 菜单ID

**移除菜单操作图**:

```
┌───────────────┐                ┌───────────────┐
│  管理员用户   │                │     菜单      │
│               │                │               │
└───────┬───────┘                └───────┬───────┘
        │                                │
        │         ┌───────────────┐      │
        │         │   UserMenu    │      │
        └─────────┤   (删除)      ├──────┘
                  │               │
                  └───────────────┘
```

#### 2.4 批量移除管理员菜单

- **请求方法**: `DELETE`
- **URL路径**: `/api/v1/menus/admins/{user_id}/menus/batch/`
- **权限**: 仅限超级管理员
- **描述**: 批量移除管理员的菜单
- **路径参数**:
  - `user_id`: 管理员用户ID
- **请求体**:
  ```
  ┌───────────────────────────┐
  │ 批量移除请求              │
  ├───────────────────────────┤
  │ {                         │
  │   "menu_ids": [1, 2, 3]   │
  │ }                         │
  └───────────────────────────┘
  ```

### 3. 当前用户菜单API

#### 概览

```
┌─────────────────────────────────┐
│      当前用户菜单 API           │
└────┬────────────────────────────┘
     │
     └── GET    /api/v1/menus/user/  - 获取当前用户的菜单
```

#### 3.1 获取当前用户的菜单

- **请求方法**: `GET`
- **URL路径**: `/api/v1/menus/user/`
- **权限**: 任何认证用户
- **描述**: 获取当前登录用户能够访问的菜单列表（基于其角色和权限）

**用户菜单获取流程图**:

```
┌─────────┐      ┌────────────┐      ┌────────────┐
│         │ 请求 │            │ 查询 │            │
│ 用户    │─────►│ 控制器     │─────►│ 用户权限   │
│         │      │            │      │            │
└─────────┘      └────────────┘      └────────────┘
    ▲                  │                   │
    │                  │                   ▼
    │                  │            ┌────────────┐
    │                  │            │            │
    │                  │            │ 菜单查询   │
    │                  │            │            │
    │                  │            └────────────┘
    │                  │                   │
    │                  ▼                   │
    │           ┌────────────┐             │
    │           │            │             │
    └───────────┤ 构建树形   │◄────────────┘
      返回菜单  │ 菜单结构   │
                └────────────┘
```

**响应数据结构**:

```
┌───────────────────────────────────┐
│ 用户菜单响应数据结构              │
├───────────────────────────────────┤
│ {                                 │
│   "menus": [                      │
│     {                             │
│       "id": 1,                    │
│       "name": "用户管理",         │
│       "code": "user_management",  │
│       "icon": "user-group",       │
│       "path": "/users",           │
│       "component": "...",         │
│       "order": 1,                 │
│       "children": [               │
│         {                         │
│           "id": 2,                │
│           "name": "用户列表",     │
│           "code": "user_list",    │
│           "icon": "list",         │
│           "path": "/users/list",  │
│           "component": "...",     │
│           "order": 1,             │
│           "children": []          │
│         }                         │
│       ]                           │
│     }                             │
│   ]                               │
│ }                                 │
└───────────────────────────────────┘
```

## 状态码与业务码

### HTTP状态码

| 状态码 | 描述 |
|--------|------|
| 200 | 操作成功 |
| 201 | 创建成功 |
| 204 | 删除成功 |
| 400 | 请求数据无效 |
| 401 | 未授权（未提供有效令牌） |
| 403 | 权限不足（无权执行该操作） |
| 404 | 资源不存在 |
| 409 | 资源冲突（例如，重复的菜单代码） |
| 500 | 服务器内部错误 |

### 业务码

| 业务码 | 描述 |
|--------|------|
| 2000 | 操作成功 |
| 4000 | 请求参数错误 |
| 4001 | 未授权 |
| 4003 | 权限不足 |
| 4004 | 资源不存在 |
| 4009 | 资源冲突 |
| 5000 | 服务器内部错误 |

## 权限模型

```
┌─────────────────────────────┐
│        API权限模型          │
├─────────────────────────────┤
│                             │
│  ┌─────────────┐            │
│  │ 普通用户    │            │
│  │             │            │
│  └─────┬───────┘            │
│        │                    │
│        ▼                    │
│  ┌─────────────┐            │
│  │ 管理员      │            │
│  │             │            │
│  └─────┬───────┘            │
│        │                    │
│        ▼                    │
│  ┌─────────────┐            │
│  │ 超级管理员  │            │
│  │             │            │
│  └─────────────┘            │
│                             │
└─────────────────────────────┘
```

| 用户角色 | 可访问的API |
|---------|------------|
| 普通用户 | - 获取当前用户菜单 |
| 管理员 | - 获取当前用户菜单<br>- 获取菜单列表（仅限已分配菜单）<br>- 获取菜单树 |
| 超级管理员 | - 所有API |

## 安全要求

为确保API的安全性，请遵循以下要求：

1. 所有API请求必须通过HTTPS发送
2. 请求头中必须包含有效的JWT令牌: `Authorization: Bearer {token}`
3. 令牌有效期通常为24小时，过期后需要重新认证
4. 敏感操作（如菜单创建、更新、删除）仅限超级管理员执行 