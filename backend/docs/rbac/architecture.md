# RBAC系统架构设计

## 1. 整体架构

RBAC系统将作为一个独立的Django应用集成到现有项目中，与用户系统和租户系统紧密协作。

## 2. 架构图

### 2.1 RBAC核心模型关系

```
+-------------+      +-------------+      +-------------+
|    User     |      |    Role     |      | Permission  |
+-------------+      +-------------+      +-------------+
| id          |<--+  | id          |<--+  | id          |
| username    |   |  | name        |   |  | code        |
| ...         |   |  | code        |   |  | name        |
+-------------+   |  | tenant_id   |   |  | category    |
                  |  +-------------+   |  | description |
                  |                    |  +-------------+
                  |  +-------------+   |
                  +--| UserRole    |   |
                     +-------------+   |
                     | user_id     |   |
                     | role_id     |   |
                     | is_active   |   |
                     | start_time  |   |
                     | end_time    |   |
                     +-------------+   |
                                       |
                                       |  +-------------+
                                       +--| RolePermission|
                                          +-------------+
                                          | role_id     |
                                          | permission_id|
                                          +-------------+
```

### 2.2 系统集成架构

```
+-------------------+      +-------------------+
|   前端应用        |      |   管理后台        |
+-------------------+      +-------------------+
         |                          |
         v                          v
+-------------------+      +-------------------+
|   API接口层       |<---->|   RBAC权限控制    |
+-------------------+      +-------------------+
         |                          ^
         v                          |
+-------------------+      +-------------------+
|   业务逻辑层      |----->|   权限检查服务    |
+-------------------+      +-------------------+
         |                          ^
         v                          |
+-------------------+      +-------------------+
|   数据访问层      |<---->|   权限缓存服务    |
+-------------------+      +-------------------+
         |
         v
+-------------------+
|   数据库          |
+-------------------+
```

## 3. 组件说明

### 3.1 RBAC核心组件

1. **权限管理模块**
   - 权限定义和管理
   - 权限分类和组织

2. **角色管理模块**
   - 角色定义和管理
   - 角色权限分配

3. **用户角色管理模块**
   - 用户角色分配
   - 角色有效期管理

4. **权限检查模块**
   - API权限检查
   - 对象级权限检查
   - 功能权限检查

5. **权限缓存模块**
   - 用户权限缓存
   - 角色权限缓存
   - 缓存失效管理

### 3.2 与现有系统集成点

1. **用户系统集成**
   - 扩展User模型的权限检查方法
   - 用户创建/修改时的角色分配

2. **认证系统集成**
   - JWT令牌中包含权限信息
   - 认证过程中进行权限预加载

3. **API系统集成**
   - 基于DRF的权限类扩展
   - API文档中包含权限要求

4. **租户系统集成**
   - 租户级角色和权限隔离
   - 租户管理员的权限管理

## 4. 数据流

### 4.1 权限检查流程

1. 用户发起请求
2. JWT认证获取用户身份
3. 权限中间件检查用户权限
4. 如有权限，继续处理请求
5. 如无权限，返回403错误

### 4.2 权限缓存流程

1. 首次权限检查时从数据库加载
2. 将权限结果存入缓存
3. 后续请求直接从缓存获取
4. 权限变更时清除相关缓存

## 5. 部署架构

RBAC系统将作为核心组件部署，与主应用共同运行：

```
+-----------------------------------+
|             Web服务器             |
+-----------------------------------+
              |
              v
+-----------------------------------+
|           Django应用              |
|  +------------+  +------------+   |
|  |  主应用    |  |  RBAC应用  |   |
|  +------------+  +------------+   |
+-----------------------------------+
              |
              v
+-----------------------------------+
|             数据库                |
+-----------------------------------+
              |
              v
+-----------------------------------+
|             缓存服务              |
+-----------------------------------+
``` 