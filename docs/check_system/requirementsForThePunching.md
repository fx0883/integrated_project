# 自律打卡系统需求说明书（优化版 - 支持自定义打卡类型）

## 1. 项目概述

### 1.1 核心目标
本系统旨在设计一个灵活、易用的自律打卡工具。核心特点是支持用户自定义打卡类型，并复用现有租户管理系统的用户体系。通过帮助用户对打卡任务进行个性化分类管理、记录每日打卡情况并提供统计分析，最终提升用户的自律性和目标达成效率。

### 1.2 核心功能亮点
*   **用户体系复用**: 无缝对接租户管理系统，确保用户数据一致性和隔离性。
*   **灵活的打卡类型**: 提供系统预设的基础类型，并允许用户创建、管理个人专属的打卡类型，实现任务的精细化分类。
*   **任务管理**: 支持用户创建基于预设模板或完全自定义的打卡任务，明确任务目标、关联特定类型，并设定有效的执行周期。
*   **打卡记录**: 提供便捷的打卡操作，忠实记录用户每日任务完成情况。
*   **多维度统计**: 提供基于时间、打卡类型（系统预设/用户自定义）等多个维度的打卡数据统计与可视化图表分析，帮助用户洞察自律行为模式。

## 2. 用户体系

*   **用户来源**: 系统不独立管理用户，直接复用租户管理系统的用户数据。用户的注册、登录、基础信息管理等操作均由租户系统负责。
*   **用户标识**: 系统内部通过租户系统提供的唯一 `user_id` 来识别和关联用户的所有数据。
*   **数据隔离**: 严格遵守数据隔离原则，确保每个用户的数据（包括任务、自定义类型、打卡记录等）仅对其本人可见和可管理，除非未来引入明确的共享机制。这通过在所有核心数据实体中存储 `user_id` 实现。

## 3. 核心概念定义

### 3.1 打卡类型 (Task Category)
打卡类型是用户为打卡任务设定的分类标签，用于组织和管理不同性质的任务。系统支持两种类型：

*   **系统预设类型**:
    *   由系统平台预先定义并提供的通用基础分类，例如："习惯养成"、"学习提升"、"健康运动"、"工作事务"等。这些类型旨在为用户提供快速开始的选项。
    *   所有用户均可看到并选用这些预设类型。
    *   通常由系统管理员进行维护，可能包括编辑类型的描述或添加新的通用类型，但核心的基础预设类型（如"习惯"）一般不允许被删除，以保证基础分类的稳定性。
    *   在数据层面，这些类型通常没有关联具体的 `user_id`（或使用一个特殊标识符）。
*   **用户自定义类型**:
    *   用户根据个人需求和偏好，自行创建的个性化分类标签，例如："晨间冥想"、"阅读专业书籍"、"项目 A 跟进"、"每周健身房训练"等。这提供了极大的灵活性。
    *   **隐私性**: 默认情况下，用户自定义类型仅对创建该类型的用户本人可见和可管理。
    *   **所有权**: 每个自定义类型都明确关联创建者的 `user_id`。
    *   **命名唯一性**: 为了避免混淆，系统要求同一用户创建的自定义类型名称不能重复。不同用户可以创建同名的自定义类型。

### 3.2 打卡任务 (Task)
打卡任务是用户设定并承诺需要周期性完成的具体事项或目标。

*   **核心属性**: 每个任务都需要定义清晰的**任务名称**，选择一个**打卡类型**（系统预设或用户自定义）进行归类，设定任务的**有效期**（明确的开始日期，以及可选的结束日期，若不设结束日期则视为长期有效任务），并关联到所属的**用户 `user_id`**。此外，还可以包含更详细的**任务描述**、完成标准等补充信息。
*   **任务来源**:
    *   **用户自定义创建**: 用户从零开始，手动输入任务的各项属性来创建新任务。
    *   **基于模板创建**: 系统可以提供一些常见的打卡任务模板（例如："坚持早起"、"每日阅读 30 分钟"）。用户选择模板后，系统可以预填部分任务属性（如任务名称、描述、甚至预设一个推荐的打卡类型），用户在此基础上进行修改和确认，快速创建任务。

## 4. 功能需求详述

### 4.1 打卡类型管理 (CRUD - 针对用户自定义类型)

用户需要能够方便地管理自己的个性化打卡类型。

*   **创建 (Create)**:
    *   **入口**: 在类型管理界面或任务创建/编辑过程中，应提供清晰的"新建类型"或类似按钮/链接。
    *   **操作流程**: 用户点击入口后，系统应弹出表单或相应界面，要求用户输入：
        *   **类型名称**: 必填项，系统需校验该名称在当前用户下是否已存在，若重复则提示用户修改。长度建议限制（如 20 个字符）。
        *   **类型描述**: 可选项，允许用户添加更详细的说明。长度建议限制（如 100 个字符）。
    *   **系统处理**: 用户确认提交后，系统自动将该类型与当前登录用户的 `user_id` 关联，并标记为用户自定义类型 (`is_system = 0`)，保存至数据库。
    *   **反馈**: 操作成功后应给予用户明确的提示信息，并更新类型列表。
    *   **关键日志**: 系统应记录类型创建事件，包含操作用户ID、创建时间、类型名称等信息，用于审计和问题追踪。
*   **读取/查询 (Read/List/Filter)**:
    *   **展示场景**: 用户在管理个人类型、创建/编辑任务选择类型、查看任务列表进行筛选、查看统计报告按类型分组等多个场景下需要看到类型列表。
    *   **列表内容**: 类型列表应清晰展示类型的名称，并能区分"系统预设类型"和"我的自定义类型"（例如通过分组、标签或不同样式）。用户自定义类型列表建议按创建时间或名称排序。
    *   **筛选能力**: 在任务列表和统计报告页面，应提供类型筛选器，允许用户选择查看：
        *   所有类型
        *   仅系统预设类型
        *   仅我的自定义类型
        *   （未来可扩展）选择一个或多个具体类型
    *   **类型选择控件**: 在创建/编辑任务时，用于选择类型的控件（如下拉菜单、选择列表等）应整合系统预设类型和当前用户的自定义类型，提供良好的浏览和选择体验，建议支持关键词搜索以快速定位类型。
*   **更新 (Update)**:
    *   **可编辑对象**: 用户**只能**修改自己创建的自定义类型的名称和描述。系统预设类型的描述可能由管理员后台更新。
    *   **操作流程**: 用户在类型管理列表中选择某个自定义类型，点击"编辑"按钮，系统弹出与创建类似的表单，回填该类型当前信息，用户修改后提交。同样需要进行名称唯一性校验。
    *   **反馈**: 更新成功后给予提示，并刷新列表。
    *   **关键日志**: 记录类型编辑事件，包含用户ID、被编辑类型ID、修改时间、修改前后的内容等。
*   **删除 (Delete)**:
    *   **可删除对象**: 用户**只能**删除自己创建的自定义类型。系统预设类型不允许用户删除（管理员或可进行"禁用"等操作，而非物理删除）。
    *   **删除约束**: 在执行删除操作前，系统**必须**检查该自定义类型当前是否被任何**未完成或进行中**的任务所关联。
        *   如果**没有**任务关联，则允许删除。
        *   如果**有**任务关联，则应**阻止删除**，并给出明确提示，建议用户先修改相关任务的类型或将任务归档/删除后，再尝试删除类型。
    *   **操作流程**: 用户在类型管理列表中选择某个自定义类型，点击"删除"按钮。系统执行上述检查，若满足删除条件，则在二次确认（例如弹窗提示"确定要删除吗？"）后执行删除操作。
    *   **反馈**: 删除成功后给予提示，并从列表移除该类型。
    *   **关键日志**: 记录类型删除事件，包含用户ID、被删除类型ID、删除时间等。

### 4.2 打卡任务管理

用户管理其需要打卡的具体事项。

*   **创建任务**:
    *   **入口**: 在任务列表页面提供"新建任务"按钮。
    *   **创建方式**: 用户可以选择：
        *   **从空白创建**: 手动填写所有任务属性。
        *   **从模板创建**: 选择一个系统预设模板，快速填充部分信息，再进行个性化调整。
    *   **必填信息**:
        *   **任务名称**: 清晰说明打卡目标（如"每天跑步 5 公里"）。
        *   **打卡类型**: 必须从包含系统预设和用户自定义类型的列表中选择一个进行关联。
        *   **开始日期**: 任务从哪天开始生效。
    *   **可选信息**:
        *   **结束日期**: 任务到哪天失效。若不填，则为长期任务。
        *   **任务描述**: 更详细的说明、注意事项或完成标准。
        *   **提醒设置** (可选扩展): 如设置每日提醒时间。
    *   **系统处理**: 保存任务信息，关联当前用户 `user_id` 和选择的 `category_id`。
    *   **反馈**: 创建成功后跳转到任务列表或任务详情页，并给出成功提示。
    *   **关键日志**: 记录任务创建事件，包括用户ID、任务名称、关联类型ID、有效期等。
*   **编辑任务**:
    *   **入口**: 在任务列表或任务详情页提供"编辑"按钮。
    *   **可编辑内容**: 允许用户修改任务的名称、描述、关联的**打卡类型**、开始日期、结束日期、状态（如从"进行中"改为"暂停"）等。
    *   **操作流程**: 点击编辑后，加载当前任务信息到表单中，用户修改后提交。
    *   **反馈**: 更新成功后提示用户，并刷新显示任务信息。
    *   **关键日志**: 记录任务编辑事件，包含用户ID、任务ID、修改时间、修改的字段及新旧值。
*   **删除任务**:
    *   **入口**: 在任务列表或任务详情页提供"删除"按钮。
    *   **影响**: 用户可以删除自己创建的任务。删除任务是独立操作，**不影响**该任务所关联的打卡类型（类型可以被其他任务继续使用）。相关的打卡记录通常也应一并处理（逻辑删除或物理删除，根据策略决定）。
    *   **操作流程**: 用户点击删除，系统进行二次确认后执行删除操作。
    *   **反馈**: 删除成功后提示用户，并从任务列表中移除。
    *   **关键日志**: 记录任务删除事件，包括用户ID、被删除任务ID、删除时间。
*   **查看任务**:
    *   **主要视图**: 用户应有一个清晰的任务列表视图，展示所有"进行中"或用户选择状态的任务。
    *   **列表信息**: 每项任务应至少显示任务名称、关联类型、今日打卡状态（已打卡/未打卡/不适用）。
    *   **筛选与排序**: 提供按**打卡类型**（系统/自定义/具体类型）、任务状态（进行中/已归档/全部）、有效期等条件进行筛选的功能。支持按创建时间、名称、类型等排序。
    *   **任务详情**: 点击任务列表项可进入任务详情页，查看任务的全部属性、历史打卡记录、相关统计等。

### 4.3 打卡记录

记录用户完成任务的行为。

*   **执行打卡**:
    *   **入口**: 在当日的任务列表视图中，每个处于有效期内且当天需要打卡的任务旁边，应提供一个清晰的"打卡"按钮或可交互元素（如复选框）。
    *   **操作流程**: 用户点击"打卡"按钮。
    *   **系统处理**: 系统记录一条打卡日志，关联当前用户 `user_id`、对应的 `task_id`，记录当前的日期 `check_in_date` 和具体时间 `check_in_time`。
    *   **防止重复**: 系统需要校验该用户当天是否已对该任务打过卡，如果已打卡，则"打卡"按钮应变为不可用状态或显示为"已打卡"，并阻止重复记录。
    *   **反馈**: 打卡成功后，界面上该任务的状态应实时更新为"已打卡"，并可能伴有短暂的成功动画或提示。
    *   **(可选)** **补充信息**: 可以在打卡时允许用户添加简短的备注（如"今天跑了 6 公里，状态不错！"）或上传图片（需额外设计）。
*   **查看记录**:
    *   **入口**: 通常在任务详情页或专门的打卡日历/历史记录页面查看。
    *   **展示方式**: 可以是列表形式（按日期倒序显示打卡时间、任务名称、备注等），也可以是日历视图（在日历中标注哪些天完成了打卡）。
*   **关键日志**: 记录每一次成功的打卡操作事件，包括用户ID、任务ID、打卡时间、日期，以及可能的备注信息。同时，对于阻止重复打卡的操作也应有日志记录。

### 4.4 数据统计与分析

为用户提供打卡行为的量化反馈和洞察。

*   **统计维度与筛选**:
    *   **时间范围**: 用户可以选择预设的时间范围（如"本周"、"本月"、"今年"）或自定义起止日期来查看统计数据。
    *   **类型范围**: 用户可以选择查看：
        *   **全部类型**的汇总统计。
        *   **仅系统预设类型**的汇总统计。
        *   **仅我的自定义类型**的汇总统计。
        *   选择**一个或多个具体类型**进行统计分析。
*   **核心统计指标 (按所选时间和类型范围计算)**:
    *   **应打卡任务数/次数**: 在选定时间范围内，理论上应该打卡的任务总数或总次数（需要根据任务频率计算，例如每日任务算每天，每周一次任务算一次）。
    *   **实际打卡次数**: 用户在选定范围内实际完成的打卡总次数。
    *   **打卡率/完成率**: （实际打卡次数 / 应打卡次数）* 100%。这是衡量执行度的关键指标。
    *   **坚持天数**: 针对单个任务，可以统计其最长连续打卡天数、累计打卡天数等。
    *   **按类型细分**: 以上指标不仅要有总览，还要能按具体的打卡类型（系统预设/用户自定义）进行分组展示，让用户了解不同类别任务的完成情况。例如，"本月'学习提升'类任务打卡率 80%，'健康运动'类任务打卡率 60%"。
*   **数据可视化展示**:
    *   **多样化图表**: 使用如图表来直观呈现统计结果，例如：
        *   **饼图**: 展示不同打卡类型在总打卡次数中的占比。
        *   **柱状图**: 对比不同打卡类型（或不同任务）的完成率；或展示每日/每周/每月的打卡次数趋势。
        *   **折线图**: 展示打卡率随时间的变化趋势。
        *   **日历热力图**: 在日历上用颜色深浅表示每天的打卡完成度。
    *   **清晰标记**: 在图表中，应使用不同的颜色、标签或其他视觉元素清晰地区分系统预设类型和用户自定义类型的数据。
    *   **交互性**: 图表应具备一定的交互性，例如鼠标悬停显示具体数值。
*   **数据导出 (可选)**: 提供将统计数据导出为 CSV 或 Excel 文件的功能，方便用户进行线下分析或备份。
*   **关键日志**: 记录用户查询统计报告的操作，包括查询的时间范围、类型范围等条件，有助于分析用户关注点和优化统计功能。

## 5. 数据存储需求 (概念性)

为了实现上述功能，系统需要持久化存储以下核心数据实体的信息：

*   **打卡类型 (Task Category)**:
    *   需要存储的信息：类型唯一标识、类型名称、类型描述、区分是系统预设还是用户自定义的标志、如果是用户自定义类型则需关联所属用户的 `user_id`、创建和更新时间戳。
*   **打卡任务 (Task)**:
    *   需要存储的信息：任务唯一标识、任务名称、任务描述、关联的打卡类型标识 (`category_id`)、所属用户的 `user_id`、任务的开始日期、结束日期（可为空）、任务状态（如进行中、已归档）、关联的模板标识（如果基于模板创建，可为空）、创建和更新时间戳。
*   **打卡记录 (Check-in Log)**:
    *   需要存储的信息：记录唯一标识、关联的任务标识 (`task_id`)、执行打卡的用户标识 (`user_id`)、打卡的日期、具体的打卡时间戳、可选的打卡备注或附加信息、创建时间戳。

*（注意：此处移除了具体的数据库表结构、字段类型、约束和索引建议，仅保留对需要存储的数据内容的描述。）*

## 6. 业务规则与约束

*   **类型名称唯一性**: 系统需确保：① 系统预设类型的名称全局唯一；② 每个用户创建的自定义类型，在其自己的类型集合内名称唯一。
*   **数据关联与完整性**:
    *   删除一个任务(`task`)时，不应影响其曾关联的打卡类型(`task_category`)，类型应可被其他任务复用。
    *   尝试删除一个用户自定义类型(`task_category`)前，系统必须检查是否存在**活动状态**的任务(`task`)仍在使用该类型。若存在，则应阻止删除，并提示用户需要先处理这些关联任务（如修改任务类型或删除任务）。
    *   当租户系统中的用户被删除或禁用时，本系统应有相应的处理策略来处理该用户遗留的自定义类型、任务和打卡记录（例如：逻辑删除、匿名化、或根据配置级联删除，需明确业务策略）。
*   **权限控制**:
    *   **访问权限**: 用户只能访问和管理（增删改查）自己的打卡任务、打卡记录和自定义打卡类型。不能访问其他用户的数据。
    *   **类型可见性**: 所有用户都能看到系统预设类型。用户自定义类型默认仅创建者可见。
    *   **管理员权限**: 应定义系统管理员角色，负责管理系统预设类型（如编辑描述、新增通用类型）和进行必要的系统维护。
*   **有效期**: 任务的打卡操作（是否需要打卡、能否打卡）以及统计计算（是否计入应打卡次数）都必须严格遵守任务设定的开始日期 (`start_date`) 和结束日期 (`end_date`)。

## 7. 与租户系统的集成

*   **用户身份认证**: 完全依赖租户系统进行用户的登录验证和身份识别。本系统需能接收并信任来自租户系统的认证结果（如通过 token 或 session 获取 `user_id`）。
*   **用户数据同步**: 无需主动同步用户基础信息，仅在需要时通过 `user_id` 从租户系统获取（如果需要展示用户名等信息）。核心是保证 `user_id` 的一致性。
*   **权限扩展 (可选考虑)**:
    *   如果租户系统有角色和权限管理机制，可以考虑将本系统的"管理员"权限与租户系统的特定角色进行绑定。
    *   可以探讨是否需要允许租户管理员查看本租户内用户的（聚合后的、非隐私的）打卡统计概览，这需要额外的权限设计。
    *   未来可以考虑增加"租户内共享类型"的功能，允许用户将自己创建的自定义类型共享给同一租户下的其他用户，需要增加相应的共享设置和权限控制。

## 8. 需求优先级

| 功能模块                                       | 优先级 | 说明                                                            |
| ---------------------------------------------- | ------ | --------------------------------------------------------------- |
| 用户自定义打卡类型创建、编辑、删除（基础管理）   | **高** | 核心功能，满足用户个性化分类需求，是系统核心价值之一。          |
| 任务创建/编辑时，能正确关联系统和自定义打卡类型 | **高** | 基础操作流程的核心环节，确保任务能被正确分类。                  |
| 任务列表展示，并支持按类型筛选（系统/自定义）     | **高** | 用户查看和管理任务的基本功能，类型筛选是重要导航方式。          |
| 基础的打卡记录功能（记录用户完成任务）         | **高** | 打卡系统的根本，没有记录就没有后续统计。                        |
| 按时间和类型维度进行数据统计与可视化图表展示     | **中** | 提升系统价值的关键功能，为用户提供行为反馈和洞察。              |
| 系统预设类型的后台管理功能（管理员使用）       | **低** | 可以在初期版本后实现，初期可手动配置或脚本初始化预设类型。      |
| 基于模板创建任务时，能预设默认打卡类型         | **中** | 提升用户体验，简化常见任务的创建流程。                          |
| 租户内共享自定义类型 (可选扩展功能)            | **低** | 属于进阶功能，可在核心功能稳定后再考虑，涉及更复杂的权限设计。 |

## 9. 非功能性需求 (初步考虑)

*   **性能**: 用户的任务列表加载、打卡操作响应、统计数据查询应在可接受的时间内完成（例如，大部分操作秒级响应）。特别是在数据量增大后，查询性能需要关注。
*   **安全性**: 严格遵守租户数据隔离原则，防止任何形式的数据泄露或越权访问。对所有用户输入进行有效的安全校验（如防止 XSS、SQL 注入等）。
*   **易用性**: 用户界面(UI)设计应简洁直观，操作流程（如创建类型、创建任务、打卡）应尽可能简化，降低用户学习成本。交互反馈需及时明确。
*   **可扩展性**: 系统设计应具备一定的灵活性，便于未来可能的扩展，例如：支持更多打卡形式（如计次、计时、数值记录）、增加社交元素（如打卡小组、好友动态）、提供更丰富的提醒机制等。
*   **可靠性**: 系统应稳定运行，打卡记录等核心数据不能丢失。需要考虑备份和恢复机制。 