# 自律打卡系统实施方案

## 一、系统架构设计

### 1. 整体架构

打卡系统将作为现有多租户系统的一个模块进行开发，复用现有的用户体系和权限控制，主要包括以下部分：

- **后端**：新增Django应用`check_system`，负责API实现
- **前端**：在`integrated_admin`中添加新模块，包括相关页面和组件
- **数据库**：新增相关数据模型，与现有用户模型关联

### 2. 数据模型设计

#### 2.1 打卡类型模型 (TaskCategory)

该模型用于存储打卡任务的分类信息，具有以下主要字段：

- **基本信息**:
  - 名称(name): 类型名称，最大长度50个字符
  - 描述(description): 类型描述，最大长度200个字符，可为空
  - 是否系统预设(is_system): 布尔值，区分系统预设和用户自定义类型
  - 图标(icon): 类型图标，最大长度50个字符，可为空
  
- **关联信息**:
  - 所属用户(user): 外键关联到User模型，系统预设类型为null
  - 所属租户(tenant): 外键关联到Tenant模型，系统预设类型为null
  
- **时间信息**:
  - 创建时间(created_at): 自动记录创建时间
  - 更新时间(updated_at): 自动记录更新时间
  
- **多语言支持**:
  - 英文名称(name_en): 英文类型名称
  - 中文名称(name_zh_hans): 中文类型名称
  - 英文描述(description_en): 英文类型描述
  - 中文描述(description_zh_hans): 中文类型描述

#### 2.2 打卡任务模型 (Task)

该模型用于存储用户创建的打卡任务，具有以下主要字段：

- **基本信息**:
  - 名称(name): 任务名称，最大长度100个字符
  - 描述(description): 任务描述，可为空
  - 状态(status): 任务状态，可选值包括进行中(active)、已完成(completed)、已暂停(paused)、已归档(archived)
  
- **关联信息**:
  - 所属类型(category): 外键关联到TaskCategory模型
  - 所属用户(user): 外键关联到User模型
  - 所属租户(tenant): 外键关联到Tenant模型
  
- **时间信息**:
  - 开始日期(start_date): 任务开始日期
  - 结束日期(end_date): 任务结束日期，可为空
  - 创建时间(created_at): 自动记录创建时间
  - 更新时间(updated_at): 自动记录更新时间
  
- **提醒设置**:
  - 是否启用提醒(reminder): 布尔值，表示是否启用提醒
  - 提醒时间(reminder_time): 提醒的具体时间，可为空

#### 2.3 打卡记录模型 (CheckRecord)

该模型用于存储用户的打卡记录，具有以下主要字段：

- **关联信息**:
  - 所属任务(task): 外键关联到Task模型
  - 所属用户(user): 外键关联到User模型
  
- **打卡信息**:
  - 打卡日期(check_date): 用户打卡的日期
  - 打卡时间(check_time): 用户打卡的具体时间
  - 备注(remarks): 打卡备注，可为空
  
- **时间信息**:
  - 创建时间(created_at): 自动记录创建时间

#### 2.4 任务模板模型 (TaskTemplate)

该模型用于存储预定义的任务模板，具有以下主要字段：

- **基本信息**:
  - 名称(name): 模板名称，最大长度100个字符
  - 描述(description): 模板描述，可为空
  - 是否系统预设(is_system): 布尔值，区分系统预设和用户自定义模板
  
- **关联信息**:
  - 所属类型(category): 外键关联到TaskCategory模型
  - 所属用户(user): 外键关联到User模型，系统预设模板为null
  - 所属租户(tenant): 外键关联到Tenant模型，系统预设模板为null
  
- **时间信息**:
  - 创建时间(created_at): 自动记录创建时间
  - 更新时间(updated_at): 自动记录更新时间
  
- **多语言支持**:
  - 英文名称(name_en): 英文模板名称
  - 中文名称(name_zh_hans): 中文模板名称
  - 英文描述(description_en): 英文模板描述
  - 中文描述(description_zh_hans): 中文模板描述

## 二、API设计

### 1. 打卡类型API

- **获取打卡类型列表**: `GET /api/v1/task-categories/`
- **创建打卡类型**: `POST /api/v1/task-categories/`
- **获取打卡类型详情**: `GET /api/v1/task-categories/{id}/`
- **更新打卡类型**: `PUT /api/v1/task-categories/{id}/`
- **删除打卡类型**: `DELETE /api/v1/task-categories/{id}/`

### 2. 打卡任务API

- **获取任务列表**: `GET /api/v1/tasks/`
- **创建任务**: `POST /api/v1/tasks/`
- **获取任务详情**: `GET /api/v1/tasks/{id}/`
- **更新任务**: `PUT /api/v1/tasks/{id}/`
- **删除任务**: `DELETE /api/v1/tasks/{id}/`

### 3. 打卡记录API

- **获取打卡记录列表**: `GET /api/v1/check-records/`
- **创建打卡记录**: `POST /api/v1/check-records/`
- **获取打卡记录详情**: `GET /api/v1/check-records/{id}/`
- **更新打卡记录**: `PUT /api/v1/check-records/{id}/`
- **删除打卡记录**: `DELETE /api/v1/check-records/{id}/`

### 4. 任务模板API

- **获取任务模板列表**: `GET /api/v1/task-templates/`
- **创建任务模板**: `POST /api/v1/task-templates/`
- **获取任务模板详情**: `GET /api/v1/task-templates/{id}/`
- **更新任务模板**: `PUT /api/v1/task-templates/{id}/`
- **删除任务模板**: `DELETE /api/v1/task-templates/{id}/`

### 5. 统计分析API

- **获取打卡统计数据**: `GET /api/v1/check-statistics/`
- **获取连续打卡数据**: `GET /api/v1/check-streaks/`
- **获取完成率数据**: `GET /api/v1/completion-rates/`

## 三、前端实现方案

### 1. 新增菜单结构

在现有的前端菜单中将添加打卡系统相关菜单，包括：

1. **打卡系统菜单**（所有用户可见）:
   - 我的任务
   - 打卡记录
   - 统计分析

2. **打卡系统管理菜单**（仅管理员可见）:
   - 类型管理
   - 模板管理

### 2. 页面组件设计

1. **任务管理页面**
   - 任务列表/详情/创建/编辑页面
   - 支持按类型筛选、状态筛选
   - 支持从模板创建任务

2. **打卡记录页面**
   - 打卡日历视图
   - 打卡记录列表
   - 快速打卡界面

3. **统计分析页面**
   - 折线图展示打卡趋势
   - 饼图展示不同类型的任务分布
   - 连续打卡天数和完成率统计

4. **类型管理页面**
   - 支持系统类型和用户自定义类型的管理
   - 多语言设置界面

5. **模板管理页面**
   - 模板列表/详情/创建/编辑页面
   - 支持系统模板和用户自定义模板

## 四、提醒功能实现

打卡提醒功能设计方案：

1. **后端定时任务**：使用Django Celery实现定时任务，根据用户设置的提醒时间发送提醒
2. **提醒方式**：
   - 站内通知（集成现有的通知系统）
   - 邮件提醒
   - 浏览器推送通知（可选）

## 五、多语言支持

多语言支持将包括以下几个方面：

1. **数据库层面**：为关键字段添加多语言版本字段，如各种名称和描述字段
2. **前端实现**：使用i18n国际化方案，支持界面语言切换
3. **API实现**：根据请求头中的语言参数返回对应语言的内容

## 六、开发计划（修订版）

### 第一阶段：后端基础开发（2周）

1. 创建新的Django应用`check_system`
2. 设计并实现数据模型
3. 设计和实现基本的序列化器（serializers）
4. 实现基础视图和权限

### 第二阶段：后端API完善（2周）

1. 完成所有API端点的开发
2. 实现数据过滤和查询
3. 编写API测试
4. 集成到DRF文档系统

### 第三阶段：后端高级功能（2周）

1. 实现统计分析功能
2. 实现提醒系统（Celery集成）
3. 实现多语言支持
4. 编写管理命令

### 第四阶段：前端开发（3周）

1. 设计并实现前端页面
2. 集成API
3. 实现多语言支持
4. 实现数据可视化

### 第五阶段：测试与优化（1周）

1. 功能测试
2. 性能测试与优化
3. Bug修复和完善

## 七、其他考虑事项

1. **权限控制**：
   - 普通用户只能管理自己的打卡任务和记录
   - 租户管理员可以查看租户内所有用户的打卡情况
   - 超级管理员可以管理系统预设类型和模板

2. **性能优化**：
   - 针对统计查询进行优化
   - 考虑缓存策略

3. **数据导出**：
   - 支持打卡记录和统计数据的导出功能
