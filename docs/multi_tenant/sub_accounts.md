# 子账号功能

子账号是用户管理系统中的一个重要功能，它允许主账号创建关联的子账号，用于数据关联和权限划分。本文档将介绍子账号的概念、用途、限制以及如何通过API创建和管理子账号。

## 子账号概念

子账号是与主账号（父账号）关联的特殊类型账号，它具有以下特点：

1. 子账号与父账号之间存在直接的关联关系
2. 子账号不能登录系统，即不能获取认证令牌
3. 子账号继承父账号的租户属性
4. 子账号不能成为管理员或超级管理员
5. 子账号不能创建其他子账号
6. 子账号默认密码为"123456"（由于不能登录，此密码不会实际使用）

子账号主要用于数据关联和权限划分，例如：
- 为不同业务场景创建独立的数据归属账号
- 为子公司或部门创建专用账号
- 实现数据隔离和权限管理

## 子账号限制

子账号有以下限制：

1. **登录限制**：子账号不能登录系统，在认证时会被拒绝
2. **权限限制**：子账号不能拥有管理员权限
3. **创建限制**：子账号不能创建其他子账号
4. **转换限制**：子账号不能被转换为普通账号（无法将父账号关联设为空）
5. **激活限制**：子账号的`is_active`始终为`False`

## 使用场景

子账号功能适用于以下场景：

1. **数据归属**：需要将数据归属于特定用户，但不希望该用户能够登录系统
2. **多部门管理**：为企业不同部门创建子账号，实现数据的部门化管理
3. **代理操作**：通过子账号实现主账号的权限代理

## API接口

### 创建子账号

通过API创建子账号非常简单，只需要调用创建子账号接口即可。由于子账号不能登录，密码字段是可选的，如果不提供则默认为"123456"。

**请求**：
- 方法：`POST`
- URL：`/api/v1/users/sub-account/create/`
- 认证：需要有效的认证令牌
- 内容类型：`application/json`

**请求参数**：

```json
{
  "username": "subaccount",
  "email": "subaccount@example.com",
  "password": "Secure@Password123",  // 可选，默认为"123456"
  "nick_name": "子账号",
  "phone": "13800138001",
  "first_name": "",
  "last_name": "",
  "avatar": ""
}
```

**请求示例（使用默认密码）**：

```json
{
  "username": "subaccount",
  "email": "subaccount@example.com",
  "nick_name": "子账号",
  "phone": "13800138001"
}
```

**响应**：

```json
{
  "success": true,
  "code": 2000,
  "message": "子账号创建成功",
  "data": {
    "id": 5,
    "username": "subaccount",
    "email": "subaccount@example.com",
    "nick_name": "子账号",
    "phone": "13800138001",
    "first_name": "",
    "last_name": "",
    "is_active": false,
    "avatar": "",
    "tenant": 1,
    "tenant_name": "测试租户",
    "is_admin": false,
    "is_member": true,
    "is_super_admin": false,
    "role": "子账号",
    "date_joined": "2025-04-22T10:00:00Z",
    "parent": 3
  }
}
```

### 获取子账号列表

可以通过用户列表API获取子账号列表，使用筛选参数过滤出当前用户的子账号。

**请求**：
- 方法：`GET`
- URL：`/api/v1/users/?parent={user_id}`
- 认证：需要有效的认证令牌

**响应**：
与标准用户列表接口响应格式相同，但只返回与指定父账号关联的子账号。

## 数据模型

在数据库中，子账号与父账号的关联通过`User`模型的`parent`字段实现：

```python
class User(AbstractUser):
    # 其他字段...
    
    # 父账号关联，用于子账号功能
    parent = models.ForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name="sub_accounts",
        verbose_name=_("父账号")
    )
    
    # 其他字段和方法...
    
    @property
    def is_sub_account(self):
        """判断是否为子账号"""
        return self.parent is not None
```

当`parent`字段为空时，用户是普通账号；当`parent`字段不为空时，用户是子账号。

## 注意事项

1. 创建子账号时，子账号会自动继承父账号的租户属性
2. 子账号不能用于登录，但可以用于数据关联和权限划分
3. 删除父账号会级联删除其所有子账号
4. 子账号在管理界面和API中会明确标识为"子账号"
5. 子账号的权限始终低于其父账号

## 最佳实践

1. 使用有意义的用户名和昵称，便于识别子账号的用途
2. 为子账号设置安全的密码，即使它们不能登录
3. 定期审查子账号列表，删除不再需要的子账号
4. 使用子账号时考虑数据隔离和权限划分的需求
5. 在创建子账号前，确保父账号有适当的权限 